<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>invariant.core documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="highlight/solarized-light.css" /><script type="text/javascript" src="highlight/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a> with <a href="https://github.com/xsc/codox-theme-rdash">RDash UI</a> theme</h2><h1><a href="index.html"><span class="project-title"><span class="project-name">invariant</span> <span class="project-version">0.1.0-SNAPSHOT</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>invariant</span></div></div></li><li class="depth-2 current"><a href="invariant.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-3"><a href="invariant.core.protocols.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>protocols</span></div></a></li><li class="depth-2 branch"><a href="invariant.debug.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>debug</span></div></a></li><li class="depth-2"><a href="invariant.spec.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>spec</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="invariant.core.html#var-acyclic"><div class="inner"><span>acyclic</span></div></a></li><li class="depth-1"><a href="invariant.core.html#var-all"><div class="inner"><span>all</span></div></a></li><li class="depth-1"><a href="invariant.core.html#var-and"><div class="inner"><span>and</span></div></a></li><li class="depth-1"><a href="invariant.core.html#var-any"><div class="inner"><span>any</span></div></a></li><li class="depth-1"><a href="invariant.core.html#var-as"><div class="inner"><span>as</span></div></a></li><li class="depth-1"><a href="invariant.core.html#var-bind"><div class="inner"><span>bind</span></div></a></li><li class="depth-1"><a href="invariant.core.html#var-check"><div class="inner"><span>check</span></div></a></li><li class="depth-1"><a href="invariant.core.html#var-collect-as"><div class="inner"><span>collect-as</span></div></a></li><li class="depth-1"><a href="invariant.core.html#var-count-as"><div class="inner"><span>count-as</span></div></a></li><li class="depth-1"><a href="invariant.core.html#var-each"><div class="inner"><span>each</span></div></a></li><li class="depth-1"><a href="invariant.core.html#var-fail"><div class="inner"><span>fail</span></div></a></li><li class="depth-1"><a href="invariant.core.html#var-fmap"><div class="inner"><span>fmap</span></div></a></li><li class="depth-1"><a href="invariant.core.html#var-holds.3F"><div class="inner"><span>holds?</span></div></a></li><li class="depth-1"><a href="invariant.core.html#var-is.3F"><div class="inner"><span>is?</span></div></a></li><li class="depth-1"><a href="invariant.core.html#var-on"><div class="inner"><span>on</span></div></a></li><li class="depth-1"><a href="invariant.core.html#var-on*"><div class="inner"><span>on*</span></div></a></li><li class="depth-1"><a href="invariant.core.html#var-on-current-value"><div class="inner"><span>on-current-value</span></div></a></li><li class="depth-1"><a href="invariant.core.html#var-property"><div class="inner"><span>property</span></div></a></li><li class="depth-1"><a href="invariant.core.html#var-recursive"><div class="inner"><span>recursive</span></div></a></li><li class="depth-1"><a href="invariant.core.html#var-run"><div class="inner"><span>run</span></div></a></li><li class="depth-1"><a href="invariant.core.html#var-state"><div class="inner"><span>state</span></div></a></li><li class="depth-1"><a href="invariant.core.html#var-unique"><div class="inner"><span>unique</span></div></a></li><li class="depth-1"><a href="invariant.core.html#var-value"><div class="inner"><span>value</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">invariant.core</h1><div class="doc"><div class="markdown"><p>API facade providing invariants on Clojure data structures.</p></div></div><div class="public anchor" id="var-acyclic"><h3>acyclic</h3><div class="usage"><code>(acyclic name edge-fn)</code><code>(acyclic name edge-fn describe-fn)</code></div><div class="doc"><div class="markdown"><p>Generates an <code>Invariant</code> verifying that there are no cyclic properties within the element currently being verified. This needs two functions:</p>
<ul>
  <li><code>edge-fn</code>: takes the state and the current value and produces a map of  node IDs to a set of successor nodes,</li>
  <li><code>describe-fn</code>: takes the state and the current value and produces a  function that maps node IDs to a more descriptive representation to  be included in errors (defaults to returning the node ID itself).</li>
</ul>
<p><code>edge-fn</code> should produce a map like the following, describing the edges of a graph constructed from the value currently being verified:</p>
<pre><code class="clojure">{:a #{:b :c}
 :c #{:d}
 :d #{:a}}
</code></pre>
<p><code>describe-fn</code> can be given to provide more information to errors (e.g. to retain more of the original input than just the node ID). E.g., if the input is a seq of nodes akin to <code>{:id "A", :children #{...}}</code> one could retain the full values using:</p>
<pre><code class="clojure">(defn describe-nodes
  [nodes]
  (into {} (map (juxt :id identity) nodes)))
</code></pre>
<p>Any error container produced by this invariant will provide the detected cycle, as well as the relevant edges within the <code>:invariant/error</code> key.</p></div></div><div class="src-link"><a href="https://github.com/xsc/invariant/blob/master/src/invariant/core.clj#L302">view source</a></div></div><div class="public anchor" id="var-all"><h3>all</h3><div class="usage"><code>(all invariant seq-invariant)</code></div><div class="doc"><div class="markdown"><p>Generates an <code>Invariant</code> that will be applied to the seq of all elements currently being verified.</p></div></div><div class="src-link"><a href="https://github.com/xsc/invariant/blob/master/src/invariant/core.clj#L281">view source</a></div></div><div class="public anchor" id="var-and"><h3>and</h3><div class="usage"><code>(and invariant &amp; more)</code></div><div class="doc"><div class="markdown"><p>Generate an <code>Invariant</code> combining all of the given ones.</p>
<pre><code class="clojure">(invariant/and
    (invariant/value :int? (comp integer? :value))
    (-&gt; (invariant/on [:children ALL])
        (invariant/each ...)))
</code></pre></div></div><div class="src-link"><a href="https://github.com/xsc/invariant/blob/master/src/invariant/core.clj#L128">view source</a></div></div><div class="public anchor" id="var-any"><h3>any</h3><div class="usage"><code>(any)</code></div><div class="doc"><div class="markdown"><p>An <code>Invariant</code> that will never produce an error.</p></div></div><div class="src-link"><a href="https://github.com/xsc/invariant/blob/master/src/invariant/core.clj#L25">view source</a></div></div><div class="public anchor" id="var-as"><h3>as</h3><div class="usage"><code>(as invariant state-key path reduce-fn initial-value)</code><code>(as invariant state-key f)</code></div><div class="doc"><div class="markdown"><p>Generates an <code>Invariant</code> that uses the given specter path, reduce fn and value to attach a key to the invariant state. Note that <code>as</code> references the input data, not the elements produced by a selector like <a href="invariant.core.html#var-on">on</a>.</p>
<pre><code class="clojure">(-&gt; (invariant/on [:usages ALL :name])
    (invariant/as :declared-variables [:declarations ALL :name] conj #{})
    ...)
</code></pre>
<p>The resulting invariant state can be used e.g. in <a href="invariant.core.html#var-bind">bind</a>, <a href="invariant.core.html#var-property">property</a> and <a href="invariant.core.html#var-state">state</a> and will be shaped similarly to the following:</p>
<pre><code class="clojure">{:declared-variables {"a", "b", "c"}}
</code></pre>
<p>Alternatively, you can also run a function directly on the input data:</p>
<pre><code class="clojure">(-&gt; (invariant/on [:usages ALL :name])
    (invariant/as :body-count (comp count :body))
    ...)
</code></pre></div></div><div class="src-link"><a href="https://github.com/xsc/invariant/blob/master/src/invariant/core.clj#L211">view source</a></div></div><div class="public anchor" id="var-bind"><h3>bind</h3><div class="usage"><code>(bind bind-fn)</code></div><div class="doc"><div class="markdown"><p>Generate an <code>Invariant</code> that will use <code>bind-fn</code>, applied to the invariant state and the value currently being verified, to decide on an invariant to use.</p>
<pre><code class="clojure">(-&gt; (invariant/on [:functions ALL])
    (invariant/each
      (invariant/bind
        (fn [_ {:keys [function-name]}]
          (case function-name
            "F" (invariant/property :f-args-valid? ...)
            "G" (invariant/property :g-args-valid? ...)
            ...)))))
</code></pre>
<p>This can be used to do invariant dispatch based on concrete values. </p></div></div><div class="src-link"><a href="https://github.com/xsc/invariant/blob/master/src/invariant/core.clj#L157">view source</a></div></div><div class="public anchor" id="var-check"><h3>check</h3><div class="usage"><code>(check invariant data)</code><code>(check invariant initial-state data)</code></div><div class="doc"><div class="markdown"><p>Like <a href="invariant.core.html#var-run">run</a> but will return either <code>nil</code> or a seq of errors.</p></div></div><div class="src-link"><a href="https://github.com/xsc/invariant/blob/master/src/invariant/core.clj#L348">view source</a></div></div><div class="public anchor" id="var-collect-as"><h3>collect-as</h3><div class="usage"><code>(collect-as invariant state-key path &amp; [{:keys [unique?], :or {unique? true}}])</code></div><div class="doc"><div class="markdown"><p>Like <a href="invariant.core.html#var-as">as</a>, collecting all elements at the given specter path at the desired key within the invariant state. If <code>:unique?</code> (default: <code>true</code>) is set the result will be a set.</p></div></div><div class="src-link"><a href="https://github.com/xsc/invariant/blob/master/src/invariant/core.clj#L249">view source</a></div></div><div class="public anchor" id="var-count-as"><h3>count-as</h3><div class="usage"><code>(count-as invariant state-key path)</code></div><div class="doc"><div class="markdown"><p>Like <a href="invariant.core.html#var-as">as</a>, storing the number of elements at the given specter path at the desired key within the invariant state.</p></div></div><div class="src-link"><a href="https://github.com/xsc/invariant/blob/master/src/invariant/core.clj#L243">view source</a></div></div><div class="public anchor" id="var-each"><h3>each</h3><div class="usage"><code>(each invariant element-invariant)</code></div><div class="doc"><div class="markdown"><p>Generates an <code>Invariant</code> that will be individually applied to all elements currently being verified.</p></div></div><div class="src-link"><a href="https://github.com/xsc/invariant/blob/master/src/invariant/core.clj#L260">view source</a></div></div><div class="public anchor" id="var-fail"><h3>fail</h3><div class="usage"><code>(fail name)</code></div><div class="doc"><div class="markdown"><p>Generate an <code>Invariant</code> that will always produce an error.</p></div></div><div class="src-link"><a href="https://github.com/xsc/invariant/blob/master/src/invariant/core.clj#L30">view source</a></div></div><div class="public anchor" id="var-fmap"><h3>fmap</h3><div class="usage"><code>(fmap invariant f)</code></div><div class="doc"><div class="markdown"><p>Transform each element currently being verified.</p>
<pre><code class="clojure">(-&gt; (invariant/on [:declarations ALL :name]
    (invariant/fmap
      #(assoc % :name-count (count (:name %))))))
</code></pre></div></div><div class="src-link"><a href="https://github.com/xsc/invariant/blob/master/src/invariant/core.clj#L145">view source</a></div></div><div class="public anchor" id="var-holds.3F"><h3>holds?</h3><div class="usage"><code>(holds? invariant data)</code><code>(holds? invariant initial-state data)</code></div><div class="doc"><div class="markdown"><p>Returns <code>true</code> if running the invariant against the given data does not produce any errors.</p></div></div><div class="src-link"><a href="https://github.com/xsc/invariant/blob/master/src/invariant/core.clj#L358">view source</a></div></div><div class="public anchor" id="var-is.3F"><h3>is?</h3><div class="usage"><code>(is? invariant self-invariant)</code></div><div class="doc"><div class="markdown"><p>Generates an <code>Invariant</code> that will be applied to the single element currently being verified. Will throw an exception if a selector like <a href="invariant.core.html#var-on">on</a> matched multiple elements.</p>
<pre><code class="clojure">(-&gt; (invariant/on [(must :right)])
    (invariant/is? tree-balanced-invariant))
</code></pre>
<p>This behaves like <a href="invariant.core.html#var-each">each</a> but will not pollute the invariant error path with a zero index.</p></div></div><div class="src-link"><a href="https://github.com/xsc/invariant/blob/master/src/invariant/core.clj#L266">view source</a></div></div><div class="public anchor" id="var-on"><h3>on</h3><h4 class="type">macro</h4><div class="usage"><code>(on path)</code></div><div class="doc"><div class="markdown"><p>Generates an <code>Invariant</code> that uses the given specter path to collect all pieces of data the invariant should apply to. This is basically a <em>selector</em>, producing elements subsequent invariants will be applied to.</p>
<pre><code class="clojure">(-&gt; (invariant/on [:declarations ALL])
    (invariant/each ...))
</code></pre>
<p>If you need to generate a selector dynamically or from a path stored within a var/binding, use <a href="invariant.core.html#var-on*">on*</a>.</p></div></div><div class="src-link"><a href="https://github.com/xsc/invariant/blob/master/src/invariant/core.clj#L54">view source</a></div></div><div class="public anchor" id="var-on*"><h3>on*</h3><div class="usage"><code>(on* path path-form)</code></div><div class="doc"><div class="markdown"><p>Generates an <code>Invariant</code> that uses the given specter path to collect all pieces of data the invariant should apply to. This is basically a <em>selector</em>, producing elements subsequent invariants will be applied to.</p>
<pre><code class="clojure">(-&gt; (invariant/on* [:declarations ALL] '[:declarations ALL])
    (invariant/each ...))
</code></pre>
<p><a href="invariant.core.html#var-on">on</a> should be preferred since it will automatically generate <code>path-form</code> for you.</p></div></div><div class="src-link"><a href="https://github.com/xsc/invariant/blob/master/src/invariant/core.clj#L37">view source</a></div></div><div class="public anchor" id="var-on-current-value"><h3>on-current-value</h3><div class="usage"><code>(on-current-value)</code></div><div class="doc"><div class="markdown"><p>An <code>Invariant</code> selector pointing at the current (i.e. top-level) value. Equivalent to <code>(on [STAY])</code> without polluting the path with <code>STAY</code> elements.</p></div></div><div class="src-link"><a href="https://github.com/xsc/invariant/blob/master/src/invariant/core.clj#L70">view source</a></div></div><div class="public anchor" id="var-property"><h3>property</h3><div class="usage"><code>(property name pred-fn)</code></div><div class="doc"><div class="markdown"><p>Generates a predicate whose <code>pred-fn</code> will be called with the invariant state and the value currently being verified.</p>
<pre><code class="clojure">(-&gt; (invariant/on [:usages ALL :name])
    (invariant/collect-as :declared-variables [:declarations ALL :name])
    (invariant/each
      (invariant/property
        :declared?
        (fn [{:keys [declared-variables]} n]
          (contains? declared-variables n)))))
</code></pre></div></div><div class="src-link"><a href="https://github.com/xsc/invariant/blob/master/src/invariant/core.clj#L79">view source</a></div></div><div class="public anchor" id="var-recursive"><h3>recursive</h3><h4 class="type">macro</h4><div class="usage"><code>(recursive [self-sym] invariant-form)</code></div><div class="doc"><div class="markdown"><p>Generate a recursive invariant bound to <code>self-sym</code> within the body.</p>
<pre><code class="clojure">(invariant/recursive
  [self]
  (invariant/and
    (invariant/value :int? (comp integer? :value))
    (-&gt; (invariant/on [:children ALL])
        (invariant/each self))))
</code></pre>
<p>The above could be used to verify e.g. the following nested map:</p>
<pre><code class="clojure">{:value 1
 :children [{:value :x
             :children [{:value 4}]}]}
</code></pre></div></div><div class="src-link"><a href="https://github.com/xsc/invariant/blob/master/src/invariant/core.clj#L179">view source</a></div></div><div class="public anchor" id="var-run"><h3>run</h3><div class="usage"><code>(run invariant data)</code><code>(run invariant initial-state data)</code></div><div class="doc"><div class="markdown"><p>Verify that the given invariant holds for the given piece of data.</p></div></div><div class="src-link"><a href="https://github.com/xsc/invariant/blob/master/src/invariant/core.clj#L341">view source</a></div></div><div class="public anchor" id="var-state"><h3>state</h3><div class="usage"><code>(state name pred-fn)</code></div><div class="doc"><div class="markdown"><p>Generates a predicate whose <code>pred-fn</code> will be called with the current state, ignoring any values currently being verified.</p>
<pre><code class="clojure">(-&gt; (invariant/on-current-value)
    (invariant/as :count count)
    (invariant/is?
      (invariant/state :at-least-one? #(pos? (:count %)))))
</code></pre>
<p>If you need the values being verified to decide on whether the invariant holds, use <a href="invariant.core.html#var-property">property</a>.</p></div></div><div class="src-link"><a href="https://github.com/xsc/invariant/blob/master/src/invariant/core.clj#L111">view source</a></div></div><div class="public anchor" id="var-unique"><h3>unique</h3><div class="usage"><code>(unique invariant name &amp; [{:keys [unique-by], :or {unique-by identity}}])</code></div><div class="doc"><div class="markdown"><p>Generates an <code>Invariant</code> verifying that all current elements are unique.</p>
<pre><code class="clojure">(-&gt; (invariant/on [:declarations ALL :name])
    (invariant/unique :declarations-unique?))
</code></pre>
<p>Errors will be reported per-element.</p></div></div><div class="src-link"><a href="https://github.com/xsc/invariant/blob/master/src/invariant/core.clj#L289">view source</a></div></div><div class="public anchor" id="var-value"><h3>value</h3><div class="usage"><code>(value name pred-fn)</code></div><div class="doc"><div class="markdown"><p>Generates a <em>stateless</em> predicate whose <code>pred-fn</code> will be called with the value currently being verified.</p>
<pre><code class="clojure">(-&gt; (invariant/on [:declarations ALL :name])
    (invariant/each
      (invariant/value :prefix-valid? #(string/starts-with? % "var_"))))
</code></pre>
<p>If you need the invariant state to decide on whether the invariant holds, use <a href="invariant.core.html#var-property">property</a>.</p></div></div><div class="src-link"><a href="https://github.com/xsc/invariant/blob/master/src/invariant/core.clj#L96">view source</a></div></div></div></body></html>